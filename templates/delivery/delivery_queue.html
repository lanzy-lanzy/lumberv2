{% extends "base.html" %}

{% block title %}Pickup Queue - Lumber Management System{% endblock %}

{% block content %}
    <div x-data="deliveryQueueApp()" x-init="init()" class="space-y-6 relative">
        <!-- Summary Cards -->
        <div class="grid grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">Pending</p>
                <p class="text-3xl font-bold text-orange-600 mt-2" x-text="deliveries.filter(d => d.status === 'pending').length"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">On Picking</p>
                <p class="text-3xl font-bold text-blue-600 mt-2" x-text="deliveries.filter(d => d.status === 'on_picking').length"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">Ready for Pickup</p>
                <p class="text-3xl font-bold text-purple-600 mt-2" x-text="deliveries.filter(d => d.status === 'loaded').length"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm">Completed Today</p>
                <p class="text-3xl font-bold text-green-600 mt-2" x-text="deliveries.filter(d => d.status === 'delivered').length"></p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b">
                <h1 class="text-xl font-bold text-gray-900">Pickup Queue</h1>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Pickup #</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Sales Order</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Customer</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Payment</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Date Created</th>
                            <th class="px-6 py-3 text-center text-sm font-medium text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-if="deliveries.length === 0">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">No pending pickups found</td>
                            </tr>
                        </template>
                        <template x-for="delivery in deliveries" :key="delivery.id">
                            <tr class="border-b hover:bg-gray-50 transition">
                                <td class="px-6 py-4 font-mono font-semibold" x-text="delivery.delivery_number"></td>
                                <td class="px-6 py-4 text-blue-600" x-text="delivery.sales_order.so_number"></td>
                                <td class="px-6 py-4" x-text="delivery.sales_order.customer_name"></td>
                                <td class="px-6 py-4">
                                    <div x-show="parseFloat(delivery.sales_order.balance) <= 0">
                                        <span class="text-green-600 font-semibold text-sm">Paid</span>
                                    </div>
                                    <div x-show="parseFloat(delivery.sales_order.balance) > 0">
                                        <span class="text-red-500 font-bold text-sm" x-text="`Bal: ₱${parseFloat(delivery.sales_order.balance).toFixed(2)}`"></span>
                                        <div class="text-xs text-gray-500" x-text="delivery.sales_order.payment_type"></div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span :class="{
                                        'bg-orange-100 text-orange-800': delivery.status === 'pending',
                                        'bg-blue-100 text-blue-800': delivery.status === 'on_picking',
                                        'bg-purple-100 text-purple-800': delivery.status === 'loaded',
                                        'bg-green-100 text-green-800': delivery.status === 'delivered'
                                    }" class="px-3 py-1 rounded-full text-xs font-medium uppercase" x-text="delivery.status === 'delivered' ? 'PICKED UP' : delivery.status.replace(/_/g, ' ')"></span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600" x-text="new Date(delivery.created_at).toLocaleDateString() + ' ' + new Date(delivery.created_at).toLocaleTimeString()"></td>
                                <td class="px-6 py-4 text-center">
                                    <div class="flex gap-2 justify-center">
                                        <template x-if="parseFloat(delivery.sales_order.balance) > 0">
                                            <button @click="recordPayment(delivery)" class="text-green-600 hover:text-green-800" title="Process Payment">
                                                <i class="fas fa-money-bill-wave"></i>
                                            </button>
                                        </template>
                                        <button @click="viewDetails(delivery)" class="text-blue-600 hover:text-blue-800" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Hidden CSRF Token -->
        {% csrf_token %}

        <!-- Payment Modal -->
        <div x-show="showPaymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;" x-transition>
            <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md" @click.away="showPaymentModal = false">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Process Payment</h2>
                    <button @click="showPaymentModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <template x-if="paymentDelivery && paymentDelivery.sales_order">
                    <form @submit.prevent="processPayment()" class="space-y-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">SO Number</p>
                            <p class="font-bold text-lg" x-text="paymentDelivery.sales_order.so_number"></p>
                            <p class="text-sm text-gray-600 mt-2">Outstanding Balance</p>
                            <p class="font-bold text-lg text-red-600" x-text="`₱${parseFloat(paymentDelivery.sales_order.balance).toFixed(2)}`"></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount to Pay *</label>
                            <input type="number" 
                                   x-model.number="paymentForm.amount"
                                   step="0.01"
                                   min="0.01"
                                   :max="parseFloat(paymentDelivery.sales_order.balance)"
                                   required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                            <select x-model="paymentForm.method" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="cash">Cash</option>
                                <option value="check">Check</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                                <i class="fas fa-check mr-2"></i>Confirm Payment
                            </button>
                            <button type="button" 
                                    @click="showPaymentModal = false" 
                                    class="flex-1 bg-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-400 transition">
                                Cancel
                            </button>
                        </div>
                    </form>
                </template>
            </div>
        </div>

        <!-- Details Modal -->
        <div x-show="showDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;" x-transition>
            <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl" @click.away="showDetailsModal = false">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                    <h2 class="text-xl font-bold">Pickup Details</h2>
                    <button @click="showDetailsModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <template x-if="selectedDelivery && selectedDelivery.sales_order">
                    <div class="p-6 space-y-4">
                        <!-- Status Badge -->
                        <div class="flex justify-between items-center">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Pickup Number</p>
                                    <p class="font-bold" x-text="selectedDelivery.delivery_number"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Status</p>
                                    <span class="inline-block px-2 py-1 bg-gray-100 rounded text-sm font-medium uppercase" x-text="selectedDelivery.status === 'delivered' ? 'PICKED UP' : selectedDelivery.status.replace(/_/g, ' ')"></span>
                                </div>
                            </div>
                            <div x-show="parseFloat(selectedDelivery.sales_order.balance) > 0">
                                 <button @click="showDetailsModal = false; recordPayment(selectedDelivery)" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">
                                    <i class="fas fa-credit-card mr-2"></i>Pay Balance: ₱<span x-text="parseFloat(selectedDelivery.sales_order.balance).toFixed(2)"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">Order Items</h3>
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-2 text-left">Product</th>
                                        <th class="px-4 py-2 text-right">Quantity</th>
                                        <th class="px-4 py-2 text-right">Board Feet</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="item in selectedDelivery.sales_order.sales_order_items" :key="item.id">
                                        <tr class="border-b">
                                            <td class="px-4 py-2" x-text="item.product_name"></td>
                                            <td class="px-4 py-2 text-right" x-text="item.quantity_pieces + ' pcs'"></td>
                                            <td class="px-4 py-2 text-right" x-text="item.board_feet + ' bf'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <div class="pt-4 border-t" x-show="selectedDelivery.status !== 'delivered'">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Update Status</label>
                            <div class="flex gap-2">
                                <button @click="updateStatus('on_picking')" x-show="selectedDelivery.status === 'pending'" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                    <i class="fas fa-box-open mr-2"></i>Start Picking
                                </button>
                                <button @click="updateStatus('delivered')" class="flex-1 bg-gray-800 text-white py-2 rounded hover:bg-gray-900">
                                    <i class="fas fa-check-circle mr-2"></i>Mark as Picked Up
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function deliveryQueueApp() {
            return {
                deliveries: [],
                showDetailsModal: false,
                selectedDelivery: null,
                
                // Payment Modal State
                showPaymentModal: false,
                paymentDelivery: null,
                paymentForm: {
                    amount: 0,
                    method: 'cash'
                },

                async init() {
                    await this.loadDeliveries();
                },

                async loadDeliveries() {
                    try {
                        const response = await fetch('/api/deliveries/pending/');
                        if (response.ok) {
                            const data = await response.json();
                            // Handle both array and object responses
                            this.deliveries = Array.isArray(data) ? data : data.results || [];
                            console.log('Deliveries loaded:', this.deliveries);
                        } else {
                            console.error('Failed to load deliveries:', response.status);
                        }
                    } catch (error) {
                        console.error('Error loading deliveries:', error);
                    }
                },

                viewDetails(delivery) {
                    console.log('View details', delivery);
                    if (!delivery || !delivery.id) {
                        toast.error('Invalid delivery data');
                        return;
                    }
                    this.selectedDelivery = delivery;
                    this.showDetailsModal = true;
                },

                recordPayment(delivery) {
                    console.log('Record payment', delivery);
                    if (!delivery || !delivery.sales_order) {
                        toast.error('Invalid delivery data');
                        return;
                    }
                    this.paymentDelivery = delivery;
                    this.paymentForm = {
                        amount: parseFloat(delivery.sales_order.balance || 0),
                        method: 'cash'
                    };
                    this.showDetailsModal = false; // Close details modal if open
                    this.showPaymentModal = true;
                },

                async processPayment() {
                    if (!this.paymentDelivery || !this.paymentDelivery.sales_order) {
                        toast.error('Invalid delivery data');
                        return;
                    }
                    
                    if (this.paymentForm.amount <= 0) {
                        toast.warning('Please enter a valid amount');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/receipts/process_payment/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken(),
                            },
                            body: JSON.stringify({
                                sales_order_id: this.paymentDelivery.sales_order.id,
                                amount_paid: this.paymentForm.amount
                            }),
                        });

                        if (response.ok) {
                            toast.success('Payment recorded successfully!');
                            this.showPaymentModal = false;
                            this.showDetailsModal = false; // Close details if open
                            await this.loadDeliveries(); // Reload to update balance
                        } else {
                            const data = await response.json();
                            toast.error('Error: ' + (data.error || 'Failed to process payment'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        toast.error('Error recording payment');
                    }
                },

                async updateStatus(newStatus) {
                    if (!this.selectedDelivery) {
                        toast.error('No delivery selected');
                        return;
                    }
                    
                    if (!(await confirm(`Update status to ${newStatus.replace(/_/g, ' ')}?`))) return;
                    
                    // Optional: Warn about unpaid balance before dispatch/delivery
                    if (this.selectedDelivery && parseFloat(this.selectedDelivery.sales_order.balance) > 0) {
                        if (!(await confirm('WARNING: This order still has an unpaid balance. Proceed anyway?'))) {
                            return;
                        }
                    }

                    try {
                        const response = await fetch(`/api/deliveries/${this.selectedDelivery.id}/update_status/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken(),
                            },
                            body: JSON.stringify({ status: newStatus })
                        });

                        if (response.ok) {
                            toast.success('Status updated successfully');
                            this.showDetailsModal = false;
                            await this.loadDeliveries();
                        } else {
                            const data = await response.json();
                            toast.error('Error: ' + (data.error || 'Failed to update status'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        toast.error('Error updating status');
                    }
                },

                getCSRFToken() {
                    return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                           document.querySelector('meta[name="csrf-token"]')?.content ||
                           this.getCookie('csrftoken');
                },

                getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
            }
        }
    </script>
{% endblock %}
