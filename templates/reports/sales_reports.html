{% extends "base.html" %}

{% block title %}Sales Reports - Lumber Management System{% endblock %}

{% block content %}
<div x-data="salesReportsApp()" x-init="init()" class="w-full">
    <div class="space-y-6">
        <!-- Header -->
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">Sales Reports</h1>
            <div class="flex gap-2">
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        <i class="fas fa-chevron-down ml-2 text-sm"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border z-50" style="display: none;">
                        <a :href="`/reports/sales/export/pdf/?date_from=${filters.dateFrom}&date_to=${filters.dateTo}&type=comprehensive`" 
                           target="_blank" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-t-lg">
                            <i class="fas fa-chart-bar mr-2 text-blue-500"></i>Comprehensive Report
                        </a>
                        <a :href="`/reports/sales/export/pdf/?date_from=${filters.dateFrom}&date_to=${filters.dateTo}&type=daily`" 
                           target="_blank" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-calendar-day mr-2 text-green-500"></i>Daily Sales
                        </a>
                        <a :href="`/reports/sales/export/pdf/?date_from=${filters.dateFrom}&date_to=${filters.dateTo}&type=customer`" 
                           target="_blank" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-users mr-2 text-purple-500"></i>By Customer
                        </a>
                        <a :href="`/reports/sales/export/pdf/?date_from=${filters.dateFrom}&date_to=${filters.dateTo}&type=product`" 
                           target="_blank" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-b-lg">
                            <i class="fas fa-box mr-2 text-orange-500"></i>By Product
                        </a>
                    </div>
                </div>
                <button @click="refreshReports()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-sync mr-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Report Tabs -->
        <div class="bg-white rounded-lg shadow border-b">
            <div class="flex gap-0 p-4 flex-wrap">
                <button @click="activeTab = 'overview'" :class="activeTab === 'overview' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="px-4 py-2 font-medium transition">
                    <i class="fas fa-chart-line mr-2"></i>Overview
                </button>
                <button @click="activeTab = 'daily'" :class="activeTab === 'daily' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="px-4 py-2 font-medium transition">
                    <i class="fas fa-calendar mr-2"></i>Daily Sales
                </button>
                <button @click="activeTab = 'by_customer'" :class="activeTab === 'by_customer' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="px-4 py-2 font-medium transition">
                    <i class="fas fa-users mr-2"></i>By Customer
                </button>
                <button @click="activeTab = 'by_product'" :class="activeTab === 'by_product' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="px-4 py-2 font-medium transition">
                    <i class="fas fa-box mr-2"></i>By Product
                </button>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="grid grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                    <input type="date" 
                           x-model="filters.dateFrom"
                           @change="applyFilters()"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                    <input type="date" 
                           x-model="filters.dateTo"
                           @change="applyFilters()"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quick Range</label>
                    <select @change="setQuickRange($event.target.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select range</option>
                        <option value="today">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">This Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="quarter">Last 90 Days</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button @click="applyFilters()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        Apply Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- OVERVIEW TAB -->
        <template x-if="activeTab === 'overview'">
            <div class="space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-gray-600 text-sm">Total Sales Orders</p>
                        <p class="text-3xl font-bold text-blue-600 mt-2" x-text="summary.totalOrders"></p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-gray-600 text-sm">Total Sales Amount</p>
                        <p class="text-3xl font-bold text-green-600 mt-2" x-text="`₱${summary.totalSales.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-gray-600 text-sm">Total Amount Paid</p>
                        <p class="text-3xl font-bold text-purple-600 mt-2" x-text="`₱${summary.totalPaid.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></p>
                    </div>
                </div>

                <!-- Cash Sales Summary -->
                <div class="bg-green-50 rounded-lg border border-green-200 p-6">
                    <p class="text-green-700 font-semibold mb-2">Cash Sales</p>
                    <p class="text-2xl font-bold text-green-600" x-text="summary.paymentByType.cash.count"></p>
                    <p class="text-sm text-green-600" x-text="`₱${summary.paymentByType.cash.amount.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></p>
                </div>

                <!-- Top Customers -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Top 10 Customers</h3>
                    <div class="space-y-3">
                        <template x-for="customer in summary.topCustomers.slice(0, 10)" :key="customer.id">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <div>
                                    <p class="font-medium" x-text="customer.name"></p>
                                    <p class="text-xs text-gray-600" x-text="customer.order_count + ' orders'"></p>
                                </div>
                                <p class="font-bold text-green-600" x-text="`₱${customer.total_sales.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <!-- DAILY SALES TAB -->
        <template x-if="activeTab === 'daily'">
            <div class="space-y-6">
                <!-- Order By Customer Toggle -->
                <div class="bg-white rounded-lg shadow p-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" x-model="filters.groupByCustomer" @change="applyFilters()" class="sr-only">
                        <div class="relative">
                            <div class="w-10 h-6 bg-gray-400 rounded-full shadow-inner" :class="filters.groupByCustomer ? 'bg-blue-600' : ''"></div>
                            <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition transform" :class="filters.groupByCustomer ? 'translate-x-4' : ''"></div>
                        </div>
                        <span class="ml-3 text-sm font-medium text-gray-700">Group by Customer</span>
                    </label>
                </div>

                <!-- Daily Sales Table - Individual Orders View -->
                <template x-if="filters.groupByCustomer">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Date/Time</th>
                                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">SO Number</th>
                                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Customer</th>
                                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Items</th>
                                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Total Sales</th>
                                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Payment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-if="dailySales.length === 0">
                                        <tr>
                                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">No sales data for selected period</td>
                                        </tr>
                                    </template>
                                    <template x-for="(sale, index) in dailySales" :key="sale.id || index">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm" x-text="new Date(sale.created_at).toLocaleString()"></td>
                                            <td class="px-6 py-4 font-mono text-sm" x-text="sale.so_number"></td>
                                            <td class="px-6 py-4 font-medium" x-text="sale.customer_name"></td>
                                            <td class="px-6 py-4 text-right" x-text="sale.sales_order_items?.length || 0"></td>
                                            <td class="px-6 py-4 text-right font-semibold" x-text="`₱${parseFloat(sale.total_amount || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                            <td class="px-6 py-4 text-sm">
                                                <span class="px-2 py-1 rounded text-xs font-medium"
                                                      :class="{
                                                          'bg-green-100 text-green-800': (sale.balance || 0) <= 0 || sale.payment_type === 'cash',
                                                          'bg-yellow-100 text-yellow-800': (sale.balance || 0) > 0 && sale.payment_type === 'partial',
                                                          'bg-red-100 text-red-800': (sale.balance || 0) > 0 && sale.payment_type === 'credit'
                                                      }"
                                                      x-text="((sale.balance || 0) <= 0 ? 'PAID' : sale.payment_type)?.toUpperCase()"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>

                <!-- Daily Sales Table - Grouped by Date View -->
                <template x-if="!filters.groupByCustomer">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Orders</th>
                                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Items Sold</th>
                                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Total Sales</th>
                                        <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Amount Paid</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-if="dailySales.length === 0">
                                        <tr>
                                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">No sales data for selected period</td>
                                        </tr>
                                    </template>
                                    <template x-for="(day, index) in dailySales" :key="day.date || index">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-6 py-4 font-medium" x-text="new Date(day.date).toLocaleDateString()"></td>
                                            <td class="px-6 py-4 text-right" x-text="day.order_count"></td>
                                            <td class="px-6 py-4 text-right" x-text="day.item_count"></td>
                                            <td class="px-6 py-4 text-right font-semibold" x-text="`₱${day.total_sales.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                            <td class="px-6 py-4 text-right text-green-600 font-semibold" x-text="`₱${day.total_paid.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- BY CUSTOMER TAB -->
        <template x-if="activeTab === 'by_customer'">
            <div class="space-y-6">
                <!-- Search/Filter -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Customer</label>
                            <input type="text" 
                                   x-model="filters.customerSearch"
                                   @keyup="applyFilters()"
                                   placeholder="Name or phone..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                            <select x-model="filters.sortCustomers" @change="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="sales_desc">Highest Sales</option>
                                <option value="orders_desc">Most Orders</option>
                                <option value="balance_desc">Highest Balance</option>
                                <option value="name_asc">Name (A-Z)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Customer Type</label>
                            <select x-model="filters.customerType" @change="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Customers</option>
                                <option value="senior">Senior Citizen</option>
                                <option value="pwd">PWD</option>
                                <option value="regular">Regular</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Customer Sales Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Customer Name</th>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Contact</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Orders</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Total Sales</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Paid</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="customerSales.length === 0">
                                    <tr>
                                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">No customer sales data</td>
                                    </tr>
                                </template>
                                <template x-for="customer in customerSales" :key="customer.id">
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium" x-text="customer.name"></td>
                                        <td class="px-6 py-4 text-sm text-gray-600" x-text="customer.phone_number"></td>
                                        <td class="px-6 py-4 text-right" x-text="customer.order_count"></td>
                                        <td class="px-6 py-4 text-right font-semibold" x-text="`₱${customer.total_sales.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                        <td class="px-6 py-4 text-right text-green-600" x-text="`₱${customer.total_paid.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                        <td class="px-6 py-4 text-right" :class="customer.balance > 0 ? 'text-red-600 font-bold' : 'text-green-600'" x-text="`₱${customer.balance.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </template>

        <!-- BY PRODUCT TAB -->
        <template x-if="activeTab === 'by_product'">
            <div class="space-y-6">
                <!-- Filters -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Product</label>
                            <input type="text" 
                                   x-model="filters.productSearch"
                                   @keyup="applyFilters()"
                                   placeholder="Product name or SKU..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select x-model="filters.categoryId" @change="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Categories</option>
                                <template x-for="cat in categories" :key="cat.id">
                                    <option :value="cat.id" x-text="cat.name"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                            <select x-model="filters.sortProducts" @change="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="revenue_desc">Revenue (High to Low)</option>
                                <option value="qty_desc">Quantity Sold (High to Low)</option>
                                <option value="orders_desc">Orders (High to Low)</option>
                                <option value="name_asc">Name (A-Z)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Product Sales Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Product</th>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Category</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Orders</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Qty (Pcs)</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Board Feet</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Avg Price/BF</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Total Revenue</th>
                                    <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">Avg Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="productSales.length === 0">
                                    <tr>
                                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">No product sales data</td>
                                    </tr>
                                </template>
                                <template x-for="product in productSales" :key="product.id">
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-6 py-4">
                                            <p class="font-medium text-sm" x-text="product.name"></p>
                                            <p class="text-xs text-gray-600" x-text="product.sku"></p>
                                        </td>
                                        <td class="px-6 py-4 text-sm" x-text="product.category_name"></td>
                                        <td class="px-6 py-4 text-right" x-text="product.order_count"></td>
                                        <td class="px-6 py-4 text-right" x-text="product.total_quantity"></td>
                                        <td class="px-6 py-4 text-right" x-text="product.total_bf.toLocaleString('en-US', {maximumFractionDigits: 2})"></td>
                                        <td class="px-6 py-4 text-right" x-text="`₱${product.avg_price.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                        <td class="px-6 py-4 text-right font-bold text-green-600" x-text="`₱${product.total_revenue.toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                        <td class="px-6 py-4 text-right text-sm" x-text="`₱${(product.total_revenue / product.order_count).toLocaleString('en-US', {maximumFractionDigits: 2})}`"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
function salesReportsApp() {
    return {
        activeTab: 'overview',
        
        // Data
        salesOrders: [],
        customers: [],
        categories: [],
        
        // Filters
        filters: {
            dateFrom: '',
            dateTo: '',
            customerSearch: '',
            productSearch: '',
            categoryId: '',
            sortCustomers: 'sales_desc',
            sortProducts: 'revenue_desc',
            customerType: '',
            groupByCustomer: true
        },
        
        // Reports Data
        summary: {
            totalOrders: 0,
            totalSales: 0,
            totalDiscount: 0,
            totalPaid: 0,
            totalItems: 0,
            avgOrderValue: 0,
            outstandingBalance: 0,
            creditOrders: 0,
            paymentByType: {
                cash: { count: 0, amount: 0 },
                partial: { count: 0, amount: 0 },
                credit: { count: 0, amount: 0 }
            },
            topCustomers: []
        },
        
        dailySales: [],
        customerSales: [],
        productSales: [],
        
        discountAnalysis: {
            totalOrders: 0,
            discountedOrders: 0,
            totalDiscount: 0,
            avgDiscount: 0,
            byType: {
                senior: { count: 0, amount: 0 },
                pwd: { count: 0, amount: 0 },
                other: { count: 0, amount: 0 }
            },
            topDiscountRecipients: []
        },

        async init() {
            // Set default date range to this month
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            this.filters.dateFrom = firstDay.toISOString().split('T')[0];
            this.filters.dateTo = today.toISOString().split('T')[0];

            await Promise.all([
                this.loadSalesOrders(),
                this.loadCategories()
            ]);
            this.applyFilters();
        },

        async loadSalesOrders() {
            try {
                // Fetch all sales orders without limit - use pagination if available
                let allOrders = [];
                let page = 1;
                let hasMore = true;

                while (hasMore) {
                    const response = await fetch(`/api/sales-orders/?page=${page}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (Array.isArray(data)) {
                            allOrders = allOrders.concat(data);
                            hasMore = false;
                        } else if (data.results) {
                            allOrders = allOrders.concat(data.results);
                            hasMore = !!data.next;
                            page++;
                        } else {
                            allOrders = allOrders.concat(data);
                            hasMore = false;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                // If pagination not available, try without pagination
                if (allOrders.length === 0) {
                    const response = await fetch('/api/sales-orders/');
                    if (response.ok) {
                        const data = await response.json();
                        allOrders = Array.isArray(data) ? data : data.results || [];
                    }
                }
                
                this.salesOrders = allOrders;
                
                // Extract unique customers
                const customerMap = {};
                this.salesOrders.forEach(order => {
                    if (!customerMap[order.customer]) {
                        customerMap[order.customer] = {
                            id: order.customer,
                            name: order.customer_name,
                            phone_number: order.phone_number || ''
                        };
                    }
                });
                this.customers = Object.values(customerMap);
            } catch (error) {
                console.error('Error loading sales orders:', error);
            }
        },

        async loadCategories() {
            try {
                const response = await fetch('/api/categories/');
                if (response.ok) {
                    const data = await response.json();
                    this.categories = Array.isArray(data) ? data : data.results || [];
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        },

        applyFilters() {
            const filtered = this.filterByDate(this.salesOrders);
            this.calculateSummary(filtered);
            this.calculateDailySales(filtered);
            this.calculateCustomerSales(filtered);
            this.calculateProductSales(filtered);
            this.calculateDiscountAnalysis(filtered);
        },

        filterByDate(orders) {
            if (!this.filters.dateFrom && !this.filters.dateTo) return orders;
            
            const fromDate = this.filters.dateFrom ? new Date(this.filters.dateFrom) : null;
            const toDate = this.filters.dateTo ? new Date(this.filters.dateTo) : null;

            return orders.filter(order => {
                const orderDate = new Date(order.created_at);
                if (fromDate && orderDate < fromDate) return false;
                if (toDate) {
                    toDate.setHours(23, 59, 59, 999);
                    if (orderDate > toDate) return false;
                }
                return true;
            });
        },

        calculateSummary(orders) {
            let totalSales = 0;
            let totalDiscount = 0;
            let totalPaid = 0;
            let totalItems = 0;
            let outstandingBalance = 0;
            let creditOrders = 0;

            const paymentByType = {
                cash: { count: 0, amount: 0 },
                partial: { count: 0, amount: 0 },
                credit: { count: 0, amount: 0 }
            };

            const customerMap = {};

            orders.forEach(order => {
                totalSales += parseFloat(order.total_amount || 0);
                totalDiscount += parseFloat(order.discount_amount || 0);
                totalPaid += parseFloat(order.amount_paid || 0);
                totalItems += order.sales_order_items?.length || 0;
                outstandingBalance += parseFloat(order.balance || 0);

                if (order.payment_type === 'credit') creditOrders += 1;

                paymentByType[order.payment_type].count += 1;
                paymentByType[order.payment_type].amount += parseFloat(order.total_amount || 0);

                // Top customers
                if (!customerMap[order.customer]) {
                    customerMap[order.customer] = {
                        id: order.customer,
                        name: order.customer_name,
                        order_count: 0,
                        total_sales: 0
                    };
                }
                customerMap[order.customer].order_count += 1;
                customerMap[order.customer].total_sales += parseFloat(order.total_amount || 0);
            });

            const topCustomers = Object.values(customerMap).sort((a, b) => b.total_sales - a.total_sales);

            this.summary = {
                totalOrders: orders.length,
                totalSales: totalSales,
                totalDiscount: totalDiscount,
                totalPaid: totalPaid,
                totalItems: totalItems,
                avgOrderValue: orders.length > 0 ? totalSales / orders.length : 0,
                outstandingBalance: outstandingBalance,
                creditOrders: creditOrders,
                paymentByType: paymentByType,
                topCustomers: topCustomers
            };
        },

        calculateDailySales(orders) {
            if (this.filters.groupByCustomer) {
                // Return individual sales orders sorted by customer name, then by date (newest first)
                const sortedOrders = [...orders].sort((a, b) => {
                    // First sort by customer name
                    const nameCompare = (a.customer_name || '').localeCompare(b.customer_name || '');
                    if (nameCompare !== 0) return nameCompare;
                    // Then sort by date (newest first)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                this.dailySales = sortedOrders;
            } else {
                // Original daily summary grouped by date - using raw totals from orders
                const dailyMap = {};

                orders.forEach(order => {
                    const date = new Date(order.created_at).toISOString().split('T')[0];
                    if (!dailyMap[date]) {
                        dailyMap[date] = {
                            date: date,
                            order_count: 0,
                            item_count: 0,
                            total_sales: 0,
                            total_discount: 0,
                            total_paid: 0,
                            cash_amount: 0,
                            partial_amount: 0,
                            credit_amount: 0
                        };
                    }

                    dailyMap[date].order_count += 1;
                    dailyMap[date].item_count += order.sales_order_items?.length || 0;
                    dailyMap[date].total_sales += parseFloat(order.total_amount || 0);
                    dailyMap[date].total_discount += parseFloat(order.discount_amount || 0);
                    dailyMap[date].total_paid += parseFloat(order.amount_paid || 0);

                    if (order.payment_type === 'cash') dailyMap[date].cash_amount += parseFloat(order.amount_paid || 0);
                    else if (order.payment_type === 'partial') dailyMap[date].partial_amount += parseFloat(order.amount_paid || 0);
                    else if (order.payment_type === 'credit') dailyMap[date].credit_amount += parseFloat(order.total_amount || 0);
                });

                this.dailySales = Object.values(dailyMap).sort((a, b) => new Date(b.date) - new Date(a.date));
            }
        },

        calculateCustomerSales(orders) {
            const customerMap = {};

            orders.forEach(order => {
                const customerId = order.customer;
                if (!customerMap[customerId]) {
                    const customer = this.customers.find(c => c.id === customerId);
                    customerMap[customerId] = {
                        id: customerId,
                        name: order.customer_name,
                        phone_number: customer?.phone_number || '',
                        is_senior: false,
                        is_pwd: false,
                        order_count: 0,
                        total_sales: 0,
                        total_discount: 0,
                        total_paid: 0,
                        balance: 0
                    };
                }

                customerMap[customerId].order_count += 1;
                customerMap[customerId].total_sales += parseFloat(order.total_amount || 0);
                customerMap[customerId].total_discount += parseFloat(order.discount_amount || 0);
                customerMap[customerId].total_paid += parseFloat(order.amount_paid || 0);
                customerMap[customerId].balance += parseFloat(order.balance || 0);
            });

            let filtered = Object.values(customerMap);

            // Apply search filter
            if (this.filters.customerSearch) {
                const search = this.filters.customerSearch.toLowerCase();
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(search) || 
                    c.phone_number.includes(search)
                );
            }

            // Apply customer type filter
            if (this.filters.customerType === 'senior') {
                filtered = filtered.filter(c => c.is_senior);
            } else if (this.filters.customerType === 'pwd') {
                filtered = filtered.filter(c => c.is_pwd);
            } else if (this.filters.customerType === 'regular') {
                filtered = filtered.filter(c => !c.is_senior && !c.is_pwd);
            }

            // Sort
            if (this.filters.sortCustomers === 'orders_desc') {
                filtered.sort((a, b) => b.order_count - a.order_count);
            } else if (this.filters.sortCustomers === 'balance_desc') {
                filtered.sort((a, b) => b.balance - a.balance);
            } else if (this.filters.sortCustomers === 'name_asc') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            } else {
                filtered.sort((a, b) => b.total_sales - a.total_sales);
            }

            this.customerSales = filtered;
        },

        calculateProductSales(orders) {
            const productMap = {};

            orders.forEach(order => {
                order.sales_order_items?.forEach(item => {
                    const productId = item.product;
                    if (!productMap[productId]) {
                        productMap[productId] = {
                            id: productId,
                            name: item.product_name,
                            sku: item.product_sku || '',
                            category_name: item.product_category_name || 'Unknown',
                            category_id: item.product_category_id,
                            order_count: 0,
                            total_quantity: 0,
                            total_bf: 0,
                            total_revenue: 0,
                            avg_price: 0
                        };
                    }

                    productMap[productId].order_count += 1;
                    productMap[productId].total_quantity += item.quantity_pieces || 0;
                    productMap[productId].total_bf += parseFloat(item.board_feet || 0);
                    productMap[productId].total_revenue += parseFloat(item.subtotal || 0);
                });
            });

            // Calculate avg price
            Object.values(productMap).forEach(product => {
                product.avg_price = product.total_bf > 0 ? product.total_revenue / product.total_bf : 0;
            });

            let filtered = Object.values(productMap);

            // Apply filters
            if (this.filters.productSearch) {
                const search = this.filters.productSearch.toLowerCase();
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(search) || 
                    p.sku.toLowerCase().includes(search)
                );
            }

            if (this.filters.categoryId) {
                const categoryId = parseInt(this.filters.categoryId);
                filtered = filtered.filter(p => p.category_id === categoryId);
            }

            // Sort
            if (this.filters.sortProducts === 'qty_desc') {
                filtered.sort((a, b) => b.total_quantity - a.total_quantity);
            } else if (this.filters.sortProducts === 'orders_desc') {
                filtered.sort((a, b) => b.order_count - a.order_count);
            } else if (this.filters.sortProducts === 'name_asc') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            } else {
                filtered.sort((a, b) => b.total_revenue - a.total_revenue);
            }

            this.productSales = filtered;
        },

        calculateDiscountAnalysis(orders) {
            let totalDiscount = 0;
            let discountedOrders = 0;
            const byType = {
                senior: { count: 0, amount: 0 },
                pwd: { count: 0, amount: 0 },
                other: { count: 0, amount: 0 }
            };
            const customerMap = {};

            orders.forEach(order => {
                const discount = parseFloat(order.discount_amount || 0);
                totalDiscount += discount;

                if (discount > 0) {
                    discountedOrders += 1;
                }

                // Track by customer
                if (!customerMap[order.customer]) {
                    customerMap[order.customer] = {
                        id: order.customer,
                        name: order.customer_name,
                        is_senior: false,
                        is_pwd: false,
                        order_count: 0,
                        total_sales: 0,
                        total_discount: 0
                    };
                }

                customerMap[order.customer].order_count += 1;
                customerMap[order.customer].total_sales += parseFloat(order.total_amount || 0);
                customerMap[order.customer].total_discount += discount;
            });

            const topRecipients = Object.values(customerMap)
                .filter(c => c.total_discount > 0)
                .sort((a, b) => b.total_discount - a.total_discount);

            this.discountAnalysis = {
                totalOrders: orders.length,
                discountedOrders: discountedOrders,
                totalDiscount: totalDiscount,
                avgDiscount: discountedOrders > 0 ? totalDiscount / discountedOrders : 0,
                byType: byType,
                topDiscountRecipients: topRecipients.slice(0, 10)
            };
        },

        setQuickRange(range) {
            const today = new Date();
            let fromDate = new Date();

            switch(range) {
                case 'today':
                    fromDate = new Date(today);
                    break;
                case 'week':
                    fromDate = new Date(today.setDate(today.getDate() - 7));
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'last_month':
                    fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    this.filters.dateTo = lastDayLastMonth.toISOString().split('T')[0];
                    this.filters.dateFrom = fromDate.toISOString().split('T')[0];
                    this.applyFilters();
                    return;
                case 'quarter':
                    fromDate = new Date(today.setDate(today.getDate() - 90));
                    break;
            }

            this.filters.dateFrom = fromDate.toISOString().split('T')[0];
            this.filters.dateTo = new Date().toISOString().split('T')[0];
            this.applyFilters();
        },

        refreshReports() {
            this.init();
        },

        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                   document.querySelector('meta[name="csrf-token"]')?.content ||
                   this.getCookie('csrftoken');
        },

        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        },
    };
}
</script>
{% endblock %}
