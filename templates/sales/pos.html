{% extends "base.html" %}

{% block title %}Point of Sale - Lumber Management System{% endblock %}

{% block content %}
<div x-data="posApp()" x-init="init()" class="w-full min-h-screen">
    <!-- Custom Styles for Animations -->
    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(249, 115, 22, 0.5); }
            50% { box-shadow: 0 0 20px rgba(249, 115, 22, 0.8); }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .product-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .product-card:hover { transform: translateY(-4px) scale(1.02); }
        .glass-card { backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.95); }
    </style>

    <div class="space-y-6 p-4">
        <!-- Header with Gradient -->
        <div class="bg-gradient-to-r from-amber-600 via-orange-500 to-amber-600 rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-white/20 backdrop-blur-sm p-3 rounded-xl">
                        <i class="fas fa-cash-register text-3xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white tracking-tight">Point of Sale</h1>
                        <p class="text-amber-100 text-sm">Lumber Management System</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button @click="resetCart()" class="bg-red-500/90 hover:bg-red-600 text-white px-5 py-2.5 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        <span>Clear Cart</span>
                    </button>
                    <button @click="toggleKeypad()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-5 py-2.5 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2 border border-white/30">
                        <i class="fas fa-keyboard"></i>
                        <span>Keypad</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Left: Product Selection -->
            <div class="col-span-2 space-y-5">
                <!-- Customer Info Card -->
                <div class="glass-card rounded-2xl shadow-xl p-5 border border-gray-100 relative z-20">
                    <div class="flex items-center gap-3 mb-5">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-2.5 rounded-xl">
                            <i class="fas fa-user text-white text-lg"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-800">Customer Information</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div class="relative">
                            <label class="block text-sm font-semibold text-gray-600 mb-2">Customer</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       x-model="searchCustomer"
                                       placeholder="Search or create customer..."
                                       @keyup="filterCustomers()"
                                       class="w-full pl-11 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-300 bg-gray-50 hover:bg-white">
                            </div>
                            <div x-show="showCustomerList" class="absolute left-0 right-0 bg-white border-2 border-amber-200 rounded-xl mt-2 z-30 max-h-56 overflow-hidden shadow-2xl">
                                <div class="max-h-40 overflow-y-auto">
                                    <template x-for="customer in filteredCustomers" :key="customer.id">
                                        <div @click="selectCustomer(customer)" class="px-4 py-3 hover:bg-amber-50 cursor-pointer transition-colors border-b border-gray-100 last:border-0">
                                            <p class="font-semibold text-gray-800" x-text="customer.name"></p>
                                            <p class="text-xs text-gray-500" x-text="customer.phone_number"></p>
                                        </div>
                                    </template>
                                </div>
                                <div class="p-3 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                                    <button @click="createNewCustomer()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2.5 rounded-lg text-sm font-semibold hover:shadow-lg transition-all duration-300">
                                        <i class="fas fa-plus mr-2"></i>New Customer
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-2">Phone Number</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400">
                                    <i class="fas fa-phone"></i>
                                </span>
                                <input type="text" 
                                       x-model="selectedCustomer.phone_number" 
                                       disabled
                                       class="w-full pl-11 pr-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-100 text-gray-600">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Selection Card -->
                <div class="glass-card rounded-2xl shadow-xl p-5 border border-gray-100">
                    <div class="flex items-center justify-between mb-5">
                        <div class="flex items-center gap-3">
                            <div class="bg-gradient-to-br from-amber-500 to-orange-500 p-2.5 rounded-xl">
                                <i class="fas fa-box text-white text-lg"></i>
                            </div>
                            <h2 class="text-lg font-bold text-gray-800">Products</h2>
                        </div>
                        <span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-sm font-semibold" x-text="`${filteredProducts.length} items`"></span>
                    </div>
                    
                    <!-- Product Search -->
                    <div class="relative mb-5">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" 
                               x-model="productSearch"
                               placeholder="Search products by name or SKU..."
                               @keyup="filterProducts()"
                               class="w-full pl-11 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-300 bg-gray-50 hover:bg-white">
                    </div>

                    <!-- Product Grid -->
                    <div class="grid grid-cols-3 gap-4 max-h-[28rem] overflow-y-auto pr-2">
                        <template x-for="product in filteredProducts" :key="product.id">
                            <div @click="product.inventory_qty > 0 ? addToCart(product) : null" 
                                 class="product-card relative rounded-xl p-4 border-2 shadow-md overflow-hidden"
                                 :class="product.inventory_qty === 0 ? 'opacity-60 cursor-not-allowed bg-gray-50 border-gray-200' : 'cursor-pointer bg-white border-gray-100 hover:border-amber-400 hover:shadow-xl'">
                                
                                <!-- Stock Badge (inside card) -->
                                <div class="absolute top-2 right-2 z-10">
                                    <span x-show="product.inventory_qty === 0" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase">Out of Stock</span>
                                    <span x-show="product.inventory_qty > 0 && product.inventory_qty <= 10" class="bg-orange-500 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase pulse-glow">Low Stock</span>
                                </div>
                                
                                <!-- Product Info -->
                                <p class="font-bold text-gray-800 text-sm mb-1 truncate pr-20" x-text="product.name"></p>
                                <p class="text-xs text-gray-500 mb-3" x-text="`${product.thickness}″ × ${product.width}″ × ${product.length}ft`"></p>
                                
                                <!-- Price Tag -->
                                <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg px-3 py-2 mb-2">
                                    <p class="text-white font-bold text-lg" x-text="`₱${(parseFloat(product.price_per_board_foot) * parseFloat(product.board_feet)).toFixed(2)}`"></p>
                                    <p class="text-green-100 text-xs">per piece</p>
                                </div>
                                
                                <!-- Stock Status -->
                                <div class="flex items-center gap-1.5">
                                    <div class="w-2 h-2 rounded-full"
                                         :class="{
                                             'bg-red-500': product.inventory_qty === 0,
                                             'bg-orange-500': product.inventory_qty > 0 && product.inventory_qty <= 10,
                                             'bg-green-500': product.inventory_qty > 10
                                         }"></div>
                                    <p class="text-xs font-semibold"
                                       :class="{
                                           'text-red-600': product.inventory_qty === 0,
                                           'text-orange-600': product.inventory_qty > 0 && product.inventory_qty <= 10,
                                           'text-green-600': product.inventory_qty > 10
                                       }"
                                       x-text="`${product.inventory_qty} pcs`"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Right: Cart Summary -->
            <div class="space-y-5">
                <!-- Cart Items -->
                <div class="glass-card rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-5 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-shopping-cart text-white text-lg"></i>
                                <h2 class="text-lg font-bold text-white">Shopping Cart</h2>
                            </div>
                            <span class="bg-amber-500 text-white text-xs px-2.5 py-1 rounded-full font-bold" x-text="`${cart.length} items`"></span>
                        </div>
                    </div>
                    
                    <div class="p-4 max-h-72 overflow-y-auto">
                        <template x-if="cart.length === 0">
                            <div class="text-center py-10">
                                <i class="fas fa-shopping-basket text-5xl text-gray-300 mb-4"></i>
                                <p class="text-gray-400 font-medium">No items in cart</p>
                                <p class="text-gray-300 text-sm">Click on products to add</p>
                            </div>
                        </template>

                        <div class="space-y-3">
                            <template x-for="(item, index) in cart" :key="index">
                                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 hover:border-amber-200 transition-all duration-300">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1 mr-2">
                                            <p class="font-semibold text-gray-800 text-sm" x-text="item.product_name.substring(0, 25)"></p>
                                            <p class="text-xs text-gray-500" x-text="`₱${parseFloat(item.price_per_piece).toFixed(2)} × ${item.quantity_pieces}`"></p>
                                        </div>
                                        <button @click="removeFromCart(index)" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-lg transition-all">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <button @click="item.quantity_pieces > 1 ? (item.quantity_pieces--, updateCartItem(index)) : null" class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center justify-center transition-colors">
                                                <i class="fas fa-minus text-xs text-gray-600"></i>
                                            </button>
                                            <input type="number" 
                                                   x-model.number="item.quantity_pieces" 
                                                   min="1"
                                                   @change="updateCartItem(index)"
                                                   class="w-14 px-2 py-1.5 border-2 border-gray-200 rounded-lg text-center text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                            <button @click="item.quantity_pieces++; updateCartItem(index)" class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center justify-center transition-colors">
                                                <i class="fas fa-plus text-xs text-gray-600"></i>
                                            </button>
                                        </div>
                                        <span class="font-bold text-gray-800" x-text="`₱${item.subtotal.toFixed(2)}`"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Summary & Payment -->
                <div class="glass-card rounded-2xl shadow-xl p-5 border border-gray-100 space-y-5">
                    <!-- Totals -->
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal</span>
                            <span class="font-semibold" x-text="`₱${summary.subtotal.toFixed(2)}`"></span>
                        </div>
                        <div class="border-t-2 border-dashed border-gray-200 pt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800">Total</span>
                                <span class="text-2xl font-bold text-green-600" x-text="`₱${summary.total.toFixed(2)}`"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Amount Paid (Cash Only) -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-600 mb-2">
                            <i class="fas fa-money-bill-wave text-green-500 mr-2"></i>Amount Paid
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-500 font-bold">₱</span>
                            <input type="number" 
                                   x-model.number="paymentData.amount_paid" 
                                   step="0.01"
                                   min="0"
                                   @change="calculateChange()"
                                   class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-gray-50 font-semibold text-lg">
                        </div>
                        <div class="mt-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 flex justify-between items-center border border-blue-200">
                            <span class="text-blue-700 font-semibold flex items-center gap-2">
                                <i class="fas fa-coins"></i> Change
                            </span>
                            <span class="text-blue-700 font-bold text-xl" x-text="`₱${paymentData.change.toFixed(2)}`"></span>
                        </div>
                    </div>

                    <!-- Checkout Button -->
                    <button @click="completeSale()" 
                            :disabled="cart.length === 0 || !selectedCustomer.id" 
                            class="w-full py-4 rounded-xl font-bold text-lg transition-all duration-300 flex items-center justify-center gap-3" 
                            :class="cart.length === 0 || !selectedCustomer.id ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:shadow-xl hover:scale-[1.02] shadow-lg'">
                        <i class="fas fa-check-circle text-xl"></i>
                        <span>Complete Sale</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Customer Modal -->
    <div x-show="showNewCustomerModal" 
         class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity" 
         x-transition.opacity
         style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg transform transition-all scale-100" 
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Create New Customer</h2>
                <button @click="showNewCustomerModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form @submit.prevent="saveNewCustomer()" class="space-y-5">
                <div class="grid grid-cols-1 gap-5">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Full Name *</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                                <i class="fas fa-user"></i>
                            </span>
                            <input type="text" 
                                   x-model="newCustomer.name" 
                                   required 
                                   placeholder="e.g. Juan dela Cruz"
                                   class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Phone Number *</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                                <i class="fas fa-phone"></i>
                            </span>
                            <input type="text" 
                                   x-model="newCustomer.phone_number" 
                                   required 
                                   placeholder="e.g. 09123456789"
                                   class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        </div>
                    </div>


                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">

                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" 
                            @click="showNewCustomerModal = false" 
                            class="flex-1 px-4 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">
                        <i class="fas fa-save mr-2"></i>Create Customer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div x-show="showReceiptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md max-h-screen flex flex-col overflow-hidden">
            <h2 class="text-2xl font-bold mb-4">Receipt</h2>
            
            <template x-if="receipt">
                <div class="space-y-4 border-b pb-4 overflow-y-auto flex-1">
                    <div>
                        <p class="text-sm text-gray-600">Receipt Number</p>
                        <p class="font-bold text-lg" x-text="receipt.receipt_number"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Date</p>
                        <p class="font-semibold" x-text="new Date().toLocaleDateString()"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Customer</p>
                        <p class="font-semibold" x-text="receipt.customer_name"></p>
                    </div>

                    <div class="border-t pt-2">
                        <p class="text-sm text-gray-600 mb-2">Items</p>
                        <template x-for="(item, index) in receipt.items" :key="index">
                            <div class="flex justify-between text-sm">
                                <span x-text="`${item.product_name} x${item.quantity_pieces}`"></span>
                                <span x-text="`₱${item.subtotal.toFixed(2)}`"></span>
                            </div>
                        </template>
                    </div>

                    <div class="border-t pt-2 space-y-1">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span x-text="`₱${receipt.subtotal.toFixed(2)}`"></span>
                        </div>
                        <div x-show="receipt.discount_amount > 0" class="flex justify-between text-green-600">
                            <span>Discount:</span>
                            <span x-text="`-₱${receipt.discount_amount.toFixed(2)}`"></span>
                        </div>
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total:</span>
                            <span class="text-green-600" x-text="`₱${receipt.total_amount.toFixed(2)}`"></span>
                        </div>
                    </div>

                    <div x-show="receipt.amount_paid > 0" class="border-t pt-2 space-y-1">
                        <div class="flex justify-between">
                            <span>Amount Paid:</span>
                            <span x-text="`₱${receipt.amount_paid.toFixed(2)}`"></span>
                        </div>
                        <div class="flex justify-between font-bold">
                            <span>Change:</span>
                            <span class="text-blue-600" x-text="`₱${receipt.change.toFixed(2)}`"></span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button @click="printReceipt()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button @click="newTransaction()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-2"></i>New
                    </button>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
function posApp() {
    return {
        products: [],
        customers: [],
        filteredProducts: [],
        filteredCustomers: [],
        searchTimeout: null,
        cart: [],
        selectedCustomer: { id: null, name: '', phone_number: '' },
        paymentData: { payment_type: 'cash', amount_paid: 0, change: 0 },
        productSearch: '',
        searchCustomer: '',
        showCustomerList: false,
        showNewCustomerModal: false,
        showReceiptModal: false,
        receipt: null,
        newCustomer: { name: '', phone_number: '' },
        summary: { subtotal: 0, discount: 0, total: 0 },

        async init() {
            await this.loadProducts();
            await this.loadCustomers();
        },

        async loadProducts() {
            try {
                const response = await fetch('/api/products/');
                if (response.ok) {
                    const data = await response.json();
                    this.products = Array.isArray(data) ? data : data.results || [];
                    this.products = this.products.map(p => ({
                        ...p,
                        inventory_qty: p.inventory?.quantity_pieces || 0,
                    }));
                    this.filterProducts();
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        },

        async loadCustomers() {
            try {
                const response = await fetch('/api/customers/');
                if (response.ok) {
                    const data = await response.json();
                    this.customers = Array.isArray(data) ? data : data.results || [];
                    this.filteredCustomers = this.customers;
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        },

        filterProducts() {
            const search = this.productSearch.toLowerCase();
            this.filteredProducts = this.products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.sku.toLowerCase().includes(search)
            );
        },

        filterCustomers() {
            const search = this.searchCustomer.toLowerCase();
            if (search.length === 0) {
                 this.filteredCustomers = this.customers;
                 return;
            }
            
            if (search.length < 2) return;

            if (this.searchTimeout) clearTimeout(this.searchTimeout);

            this.searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/pos/search_customer/?q=${encodeURIComponent(search)}`);
                    if (response.ok) {
                        this.filteredCustomers = await response.json();
                        this.showCustomerList = true;
                    }
                } catch (error) {
                    console.error('Error searching customers:', error);
                }
            }, 300);
        },

        selectCustomer(customer) {
            this.selectedCustomer = { ...customer };
            this.searchCustomer = customer.name;
            this.showCustomerList = false;
            this.calculateSummary();
        },

        createNewCustomer() {
            this.showNewCustomerModal = true;
            this.showCustomerList = false;
        },

        async saveNewCustomer() {
            try {
                const response = await fetch('/api/customers/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                    },
                    body: JSON.stringify(this.newCustomer),
                });

                if (response.ok) {
                    const customer = await response.json();
                    this.selectCustomer(customer);
                    this.showNewCustomerModal = false;
                    this.newCustomer = { name: '', phone_number: '' };
                    await this.loadCustomers();
                    toast.success('Customer created successfully');
                } else {
                    toast.error('Error creating customer');
                }
            } catch (error) {
                console.error('Error:', error);
                toast.error('Error creating customer');
            }
        },

        addToCart(product) {
            const existingItem = this.cart.find(item => item.product_id === product.id);
            
            // Calculate price per piece (board_feet * price_per_board_foot)
            const pricePerPiece = parseFloat(product.price_per_board_foot) * parseFloat(product.board_feet);
            
            if (existingItem) {
                existingItem.quantity_pieces += 1;
                this.updateCartItem(this.cart.indexOf(existingItem));
            } else {
                this.cart.push({
                    product_id: product.id,
                    product_name: product.name,
                    quantity_pieces: 1,
                    unit_price: parseFloat(product.price_per_board_foot),
                    board_feet: parseFloat(product.board_feet),
                    price_per_piece: pricePerPiece,
                    subtotal: pricePerPiece,
                });
            }
            
            this.calculateSummary();
        },

        updateCartItem(index) {
            const item = this.cart[index];
            item.subtotal = item.quantity_pieces * item.price_per_piece;
            this.calculateSummary();
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
            this.calculateSummary();
        },

        calculateSummary() {
            this.summary.subtotal = this.cart.reduce((sum, item) => sum + (parseFloat(item.subtotal) || 0), 0);
            this.summary.discount = 0;
            this.summary.total = Math.max(0, this.summary.subtotal);
            this.paymentData.amount_paid = this.summary.total;
            this.calculateChange();
        },

        calculateChange() {
            this.paymentData.change = Math.max(0, this.paymentData.amount_paid - this.summary.total);
        },

        toggleKeypad() {
            // Implementation for keypad feature
            toast.info('Keypad feature coming soon');
        },

        async resetCart(skipConfirm = false) {
             if (!skipConfirm && !(await confirm('Clear the entire cart?'))) {
                 return;
             }
             this.cart = [];
             this.selectedCustomer = { id: null, name: '', phone_number: '' };
             this.paymentData = { payment_type: 'cash', amount_paid: 0, change: 0 };
             this.searchCustomer = '';
             this.calculateSummary();
         },

        async completeSale() {
            if (this.cart.length === 0 || !this.selectedCustomer.id) {
                toast.warning('Please add items and select customer');
                return;
            }

            if (this.paymentData.payment_type === 'cash' && this.paymentData.amount_paid < this.summary.total) {
                toast.error('Insufficient payment');
                return;
            }

            try {
                const payload = {
                    customer_id: this.selectedCustomer.id,
                    items: this.cart.map(item => ({
                        product_id: item.product_id,
                        quantity_pieces: item.quantity_pieces
                    })),
                    payment_type: this.paymentData.payment_type,
                    amount_tendered: this.paymentData.amount_paid
                };

                const response = await fetch('/api/pos/quick_checkout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Calculate subtotal from actual cart items (avoid floating point precision issues)
                    const cartSubtotal = this.cart.reduce((sum, item) => sum + item.subtotal, 0);
                    
                    // Use response data for the receipt
                    this.receipt = {
                        receipt_number: data.receipt.receipt_number,
                        customer_name: data.sales_order.customer_name,
                        items: JSON.parse(JSON.stringify(this.cart)),
                        subtotal: parseFloat(cartSubtotal.toFixed(2)),
                        discount_amount: data.sales_order.discount_amount,
                        total_amount: data.sales_order.total_amount,
                        amount_paid: data.receipt.amount_tendered,
                        change: data.receipt.change,
                        created_at: new Date().toISOString()
                    };
                    
                    this.showReceiptModal = true;
                    toast.success('Sale completed successfully');
                    // Auto-print receipt
                    setTimeout(() => {
                        this.printReceipt();
                    }, 500);
                } else {
                    const data = await response.json();
                    toast.error('Error: ' + (data.detail || JSON.stringify(data)));
                }
            } catch (error) {
                console.error('Error:', error);
                toast.error('Error completing sale');
            }
        },

        newTransaction() {
             this.showReceiptModal = false;
             this.receipt = null;
             this.resetCart(true); // Auto-clear without confirmation
         },

        printReceipt() {
             if (!this.receipt) return;
             
             const printWindow = window.open('', '_blank', 'width=400,height=600');
             const self = this; // Preserve context
             const receiptHTML = `
                 <!DOCTYPE html>
                 <html>
                 <head>
                     <meta charset="UTF-8">
                     <title>Receipt - ${this.receipt.receipt_number}</title>
                     <style>
                         body { font-family: 'Courier New', monospace; margin: 0; padding: 10px; }
                         .receipt { width: 80mm; margin: 0 auto; }
                         .header { text-align: center; font-weight: bold; margin-bottom: 10px; }
                         .divider { border-bottom: 1px dashed #000; margin: 10px 0; }
                         .row { display: flex; justify-content: space-between; font-size: 12px; }
                         .label { font-weight: bold; }
                         .items { margin: 10px 0; }
                         .item-row { display: flex; justify-content: space-between; font-size: 11px; }
                         .total-row { font-size: 13px; font-weight: bold; }
                         .footer { text-align: center; font-size: 10px; margin-top: 10px; }
                         @media print {
                             body { margin: 0; padding: 0; }
                         }
                     </style>
                 </head>
                 <body>
                     <div class="receipt">
                         <div class="header">
                             <div>LUMBER MANAGEMENT SYSTEM</div>
                             <div style="font-size: 10px;">Receipt</div>
                         </div>
                         
                         <div class="divider"></div>
                         
                         <div style="font-size: 11px;">
                             <div class="row"><span class="label">Receipt #:</span><span>${this.receipt.receipt_number}</span></div>
                             <div class="row"><span class="label">Date:</span><span>${new Date(this.receipt.created_at).toLocaleDateString()}</span></div>
                             <div class="row"><span class="label">Time:</span><span>${new Date(this.receipt.created_at).toLocaleTimeString()}</span></div>
                         </div>
                         
                         <div class="divider"></div>
                         
                         <div style="font-size: 11px;">
                             <div class="row"><span class="label">Customer:</span></div>
                             <div style="text-align: center; margin: 5px 0;">${this.receipt.customer_name}</div>
                         </div>
                         
                         <div class="divider"></div>
                         
                         <div class="items">
                             ${this.receipt.items.map(item => `
                                 <div class="item-row">
                                     <span>${item.product_name}</span>
                                     <span>${item.quantity_pieces}x</span>
                                 </div>
                                 <div class="item-row" style="justify-content: flex-end; padding-right: 20px;">
                                     ₱${item.subtotal.toFixed(2)}
                                 </div>
                             `).join('')}
                         </div>
                         
                         <div class="divider"></div>
                         
                         <div style="font-size: 12px;">
                             <div class="row">
                                 <span>Subtotal:</span>
                                 <span>₱${this.receipt.subtotal.toFixed(2)}</span>
                             </div>
                             ${this.receipt.discount_amount > 0 ? `
                                 <div class="row" style="color: green;">
                                     <span>Discount (20%):</span>
                                     <span>-₱${this.receipt.discount_amount.toFixed(2)}</span>
                                 </div>
                             ` : ''}
                             <div class="divider"></div>
                             <div class="row total-row">
                                 <span>TOTAL:</span>
                                 <span>₱${this.receipt.total_amount.toFixed(2)}</span>
                             </div>
                         </div>
                         
                         <div class="divider"></div>
                         
                         <div style="font-size: 11px;">
                             <div class="row">
                                 <span class="label">Amount Paid:</span>
                                 <span>₱${this.receipt.amount_paid.toFixed(2)}</span>
                             </div>
                             <div class="row">
                                 <span class="label">Change:</span>
                                 <span>₱${this.receipt.change.toFixed(2)}</span>
                             </div>
                         </div>
                         
                         <div class="footer">
                             <div style="margin-top: 20px;">Thank you for your purchase!</div>
                             <div>${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>
                         </div>
                     </div>
                 </body>
                 </html>
             `;
             
             printWindow.document.write(receiptHTML);
             printWindow.document.close();
             
             setTimeout(() => {
                 printWindow.print();
                 
                 // Poll to detect when print window closes
                 const checkClosed = setInterval(() => {
                     try {
                         if (printWindow.closed) {
                             clearInterval(checkClosed);
                             // Close the receipt modal and start new transaction
                             self.newTransaction();
                         }
                     } catch (e) {
                         clearInterval(checkClosed);
                     }
                 }, 100);
                 
                 // Safety timeout in case polling doesn't work
                 setTimeout(() => {
                     clearInterval(checkClosed);
                     if (!printWindow.closed) {
                         printWindow.close();
                     }
                     self.newTransaction();
                 }, 3000);
             }, 250);
         },

        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                   document.querySelector('meta[name="csrf-token"]')?.content ||
                   this.getCookie('csrftoken');
        },

        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        },
    };
}
</script>
{% endblock %}
